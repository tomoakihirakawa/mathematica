Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
 
dQdt[Q_, {w0_, w1_, w2_}] := Module[{}, 
     Return[{{0, -w0, -w1, -w2} . Q/2, {w0, 0, w2, -w1} . Q/2, 
        {w1, -w2, 0, w0} . Q/2, {w2, w1, -w0, 0} . Q/2}]; ]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
 
dQdt[Q_, {w0_, w1_, w2_}] := Module[{}, 
     Return[{{0, -w0, -w1, -w2} . Q/2, {w0, 0, w2, -w1} . Q/2, 
        {w1, -w2, 0, w0} . Q/2, {w2, w1, -w0, 0} . Q/2}]; ]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[2*Join[r, zeros, 2], 
       Join[zeros, r . Tmag, 2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
 
dQdt[Q_, {w0_, w1_, w2_}] := Module[{}, 
     Return[{{0, -w0, -w1, -w2} . Q/2, {w0, 0, w2, -w1} . Q/2, 
        {w1, -w2, 0, w0} . Q/2, {w2, w1, -w0, 0} . Q/2}]; ]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
 
dQdt[Q_, {w0_, w1_, w2_}] := Module[{}, 
     Return[{{0, -w0, -w1, -w2} . Q/2, {w0, 0, w2, -w1} . Q/2, 
        {w1, -w2, 0, w0} . Q/2, {w2, w1, -w0, 0} . Q/2}]; ]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
 
dQdt[Q_, {w0_, w1_, w2_}] := Module[{}, 
     Return[{{0, -w0, -w1, -w2} . Q/2, {w0, 0, w2, -w1} . Q/2, 
        {w1, -w2, 0, w0} . Q/2, {w2, w1, -w0, 0} . Q/2}]; ]
Rs[{a_, b_, c_, d_}] := Module[{ind, s, a2, b2, c2, d2, div}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      {{a2 + b2 - c2 - d2, 2*b*c + 2*a*d, -2*a*c + 2*b*d}/s, 
       {2*b*c - 2*a*d, a2 - b2 + c2 - d2, 2*a*b + 2*c*d}/s, 
       {2*a*c + 2*b*d, -2*a*b + 2*c*d, a2 - b2 - c2 + d2}/s}]
 
Rv[{a_, b_, c_, d_}] = {{(a^4 + 2*a^2*b^2 + b^4 - c^4 - 2*c^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^2*b*c + 2*b^3*c + 2*b*c^3 - 
        2*a^3*d - 2*a*b^2*d - 2*a*c^2*d + 2*b*c*d^2 - 2*a*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (2*a^3*c + 2*a*b^2*c + 2*a*c^3 + 
        2*a^2*b*d + 2*b^3*d + 2*b*c^2*d + 2*a*c*d^2 + 2*b*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(2*a^2*b*c + 2*b^3*c + 2*b*c^3 + 2*a^3*d + 2*a*b^2*d + 2*a*c^2*d + 
        2*b*c*d^2 + 2*a*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 + 2*a^2*c^2 + c^4 - 2*b^2*d^2 - d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6), (-2*a^3*b - 2*a*b^3 - 2*a*b*c^2 + 
        2*a^2*c*d + 2*b^2*c*d + 2*c^3*d - 2*a*b*d^2 + 2*c*d^3)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}, 
     {(-2*a^3*c - 2*a*b^2*c - 2*a*c^3 + 2*a^2*b*d + 2*b^3*d + 2*b*c^2*d - 
        2*a*c*d^2 + 2*b*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (2*a^3*b + 2*a*b^3 + 2*a*b*c^2 + 2*a^2*c*d + 2*b^2*c*d + 2*c^3*d + 
        2*a*b*d^2 + 2*c*d^3)/(a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 
        6*a^2*b^2*c^2 + 3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 
        6*a^2*b^2*d^2 + 3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 
        3*c^4*d^2 + 3*a^2*d^4 + 3*b^2*d^4 + 3*c^2*d^4 + d^6), 
      (a^4 - b^4 - 2*b^2*c^2 - c^4 + 2*a^2*d^2 + d^4)/
       (a^6 + 3*a^4*b^2 + 3*a^2*b^4 + b^6 + 3*a^4*c^2 + 6*a^2*b^2*c^2 + 
        3*b^4*c^2 + 3*a^2*c^4 + 3*b^2*c^4 + c^6 + 3*a^4*d^2 + 6*a^2*b^2*d^2 + 
        3*b^4*d^2 + 6*a^2*c^2*d^2 + 6*b^2*c^2*d^2 + 3*c^4*d^2 + 3*a^2*d^4 + 
        3*b^2*d^4 + 3*c^2*d^4 + d^6)}}
 
RR[{a_, b_, c_, d_}] := Module[{zeros, r, a2, b2, c2, d2, s}, 
     a2 = a*a; b2 = b*b; c2 = c*c; d2 = d*d; s = 1; 
      zeros = Table[Table[0, {i, 0, 2, 1}], {j, 0, 2, 1}]; 
      r = Rs[{a, b, c, d}]/s; Join[Join[r, zeros, 2], Join[zeros, r . Tmag, 
        2]]]
 
Tmag = {{1, 0, 0}, {0, 1, 0}, {0, 0, 1}}
 
R[{a_, b_, c_, d_}] := Rs[{a, b, c, d}]
 
AxisAngleToQuaternion[{axX_, axY_, axZ_}, angle_] := 
    Module[{n}, n = Normalize[{axX, axY, axZ}]; 
      Return[{Cos[-angle/2], n[[1]]*Sin[-angle/2], n[[2]]*Sin[-angle/2], 
        n[[3]]*Sin[-angle/2]}]; ]
 
dQdt[Q_, {w0_, w1_, w2_}] := Module[{}, 
     Return[{{0, -w0, -w1, -w2} . Q/2, {w0, 0, w2, -w1} . Q/2, 
        {w1, -w2, 0, w0} . Q/2, {w2, w1, -w0, 0} . Q/2}]; ]
